<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BlogHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="url(#gradient)" />
                    <path d="M2 17L12 22L22 17" stroke="url(#gradient)" stroke-width="2" />
                    <defs>
                        <linearGradient id="gradient" x1="2" y1="2" x2="22" y2="22">
                            <stop offset="0%" style="stop-color:#6366f1" />
                            <stop offset="100%" style="stop-color:#8b5cf6" />
                        </linearGradient>
                    </defs>
                </svg>
                BlogHub
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item" id="dashboardLink">
                        <a class="nav-link active" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item ms-3">
                        <div class="theme-switch" onclick="toggleTheme()">
                            <span id="themeIcon">üåô</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <section class="container py-5" style="margin-top: 80px;">
        <!-- Dashboard Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-1">My Dashboard</h1>
                <p class="text-secondary mb-0">Manage your posts and content</p>
            </div>
            <a href="create-post.html" class="btn btn-primary">
                ‚úèÔ∏è New Post
            </a>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-5" id="statsRow">
            <div class="col-md-4">
                <div class="card p-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="stat-icon" style="font-size: 2rem;">üìù</div>
                        <div>
                            <div class="h3 mb-0" id="totalPosts">0</div>
                            <small class="text-secondary">Total Posts</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="stat-icon" style="font-size: 2rem;">üìÖ</div>
                        <div>
                            <div class="h3 mb-0" id="latestPostDate">‚Äî</div>
                            <small class="text-secondary">Latest Post</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="stat-icon" style="font-size: 2rem;">üë§</div>
                        <div>
                            <div class="h3 mb-0" id="userName">Author</div>
                            <small class="text-secondary">Welcome back!</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert container -->
        <div id="alertContainer"></div>

        <!-- Posts List -->
        <div class="card">
            <div class="card-header bg-white p-4 border-0 d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">Your Posts</h2>
            </div>
            <div class="card-body p-0">
                <!-- Loading spinner -->
                <div id="loadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="text-secondary mt-2">Loading your posts...</p>
                </div>

                <!-- Post table -->
                <div class="table-responsive" id="postsTableWrapper" style="display: none;">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Title</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardPostsBody">
                        </tbody>
                    </table>
                </div>

                <!-- Empty state -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                    <h3>No posts yet</h3>
                    <p class="text-secondary">Start sharing your ideas with the world!</p>
                    <a href="create-post.html" class="btn btn-primary">Create Your First Post</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer mt-auto">
        <div class="container text-center py-4">
            <p>&copy; 2024 BlogHub. All rights reserved.</p>
        </div>
    </footer>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="deleteModalLabel">‚ö†Ô∏è Delete Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this post? This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="script.js"></script>
    <script>
        let deletePostId = null;

        // Load dashboard posts (user's own posts only)
        async function loadDashboardPosts() {
            const spinner = document.getElementById('loadingSpinner');
            const tableWrapper = document.getElementById('postsTableWrapper');
            const emptyState = document.getElementById('emptyState');
            const tbody = document.getElementById('dashboardPostsBody');

            try {
                // Get current user
                const { data: { user } } = await supabaseClient.auth.getUser();
                const mockUser = JSON.parse(localStorage.getItem('demoUser'));
                const userId = user ? user.id : (mockUser ? mockUser.id : null);

                if (!userId) {
                    window.location.href = 'login.html';
                    return;
                }

                // Update user name in stats
                const displayName = user?.user_metadata?.username || user?.email || mockUser?.username || 'Author';
                document.getElementById('userName').textContent = displayName;

                // Fetch user's posts
                const { data: posts, error } = await supabaseClient
                    .from('posts')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Hide spinner
                spinner.style.display = 'none';

                // Update stats
                document.getElementById('totalPosts').textContent = posts ? posts.length : 0;

                if (!posts || posts.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                // Latest post date
                const latestDate = new Date(posts[0].created_at).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric'
                });
                document.getElementById('latestPostDate').textContent = latestDate;

                // Render posts table
                tbody.innerHTML = posts.map(post => {
                    const date = new Date(post.created_at).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                    // Strip HTML tags for clean title display
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = post.title;
                    const plainTitle = tempDiv.textContent || tempDiv.innerText || 'Untitled';
                    // Excerpt from content
                    tempDiv.innerHTML = post.content;
                    const plainContent = tempDiv.textContent || tempDiv.innerText || '';
                    const excerpt = plainContent.substring(0, 80) + (plainContent.length > 80 ? '...' : '');

                    return `
                        <tr>
                            <td class="ps-4">
                                <div>
                                    <a href="Post.html?id=${post.id}" class="fw-semibold text-decoration-none" style="color: var(--text-primary);">${plainTitle}</a>
                                    <div class="text-secondary small mt-1">${excerpt}</div>
                                </div>
                            </td>
                            <td>
                                <span class="text-secondary">${date}</span>
                            </td>
                            <td>
                                <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">Published</span>
                            </td>
                            <td class="text-end pe-4">
                                <a href="edit-post.html?id=${post.id}" class="btn btn-sm btn-outline-primary me-2" title="Edit">
                                    ‚úèÔ∏è Edit
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('${post.id}')" title="Delete">
                                    üóëÔ∏è Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                tableWrapper.style.display = 'block';

            } catch (error) {
                console.error('Error loading dashboard:', error);
                spinner.style.display = 'none';
                emptyState.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <h3>Error loading posts</h3>
                    <p class="text-secondary">${error.message}</p>
                    <button class="btn btn-primary" onclick="loadDashboardPosts()">Try Again</button>
                `;
                emptyState.style.display = 'block';
            }
        }

        // Delete modal
        function showDeleteModal(postId) {
            deletePostId = postId;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deletePostId) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const { error } = await supabaseClient
                    .from('posts')
                    .delete()
                    .eq('id', deletePostId);

                if (error) throw error;

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();

                showAlert('Post deleted successfully!', 'success');
                // Reload posts
                loadDashboardPosts();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting post: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Delete';
                deletePostId = null;
            }
        });

        // Load dashboard
        loadDashboardPosts();
    </script>
</body>
</html>
