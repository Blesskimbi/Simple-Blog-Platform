<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post - BlogHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="url(#gradient)" />
                    <path d="M2 17L12 22L22 17" stroke="url(#gradient)" stroke-width="2" />
                    <defs>
                        <linearGradient id="gradient" x1="2" y1="2" x2="22" y2="22">
                            <stop offset="0%" style="stop-color:#6366f1" />
                            <stop offset="100%" style="stop-color:#8b5cf6" />
                        </linearGradient>
                    </defs>
                </svg>
                BlogHub
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item" id="dashboardLink">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item ms-3">
                        <div class="theme-switch" onclick="toggleTheme()">
                            <span id="themeIcon">üåô</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Create Post Section -->
    <section class="container py-5" style="margin-top: 80px;">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-sm">
                    <div class="card-header bg-white p-4 border-0">
                        <h1 class="h3 mb-0">Create New Post</h1>
                    </div>
                    <div class="card-body p-4">
                        <div id="alertContainer"></div>
                        <form id="richPostForm">
                            <div class="mb-3">
                                <label for="postTitle" class="form-label">Title</label>
                                <div id="postTitle" class="form-control form-control-lg" contenteditable="true" data-placeholder="Enter an engaging title"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="postContent" class="form-label">Content</label>
                                <div class="editor-container">
                                    <div class="editor-sidebar">
                                        <button type="button" class="btn-plus" id="toggleTools" aria-label="Add content">
                                            <span>+</span>
                                        </button>
                                        <div class="tools-menu" id="toolsMenu">
                                            <button type="button" class="tool-btn" onclick="triggerUpload('image')" title="Add Image">üì∑</button>
                                            <button type="button" class="tool-btn" onclick="triggerUpload('video')" title="Add Video">üé•</button>
                                            <button type="button" class="tool-btn" onclick="triggerUpload('audio')" title="Add Audio">üéµ</button>
                                            <button type="button" class="tool-btn" onclick="insertContent('link')" title="Add Link">üîó</button>
                                            <button type="button" class="tool-btn" onclick="insertContent('embed')" title="Add Embed">üîå</button>
                                        </div>
                                    </div>
                                    <div id="editor" class="editor-content" contenteditable="true" data-placeholder="Tell your story..."></div>
                                    
                                    <!-- Hidden File Inputs -->
                                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                    <input type="file" id="videoUpload" accept="video/*" style="display: none;">
                                    <input type="file" id="audioUpload" accept="audio/*" style="display: none;">
                                </div>
                                
                                <!-- Floating Formatting Toolbar -->
                                <div id="formatToolbar" class="formatting-toolbar">
                                    <button type="button" class="format-btn" data-cmd="bold" title="Bold"><strong>B</strong></button>
                                    <button type="button" class="format-btn" data-cmd="italic" title="Italic"><em>I</em></button>
                                    <button type="button" class="format-btn" data-cmd="h2" title="Heading">H2</button>
                                    <button type="button" class="format-btn" data-cmd="h3" title="Subheading">H3</button>
                                    <button type="button" class="format-btn" data-cmd="blockquote" title="Quote">""</button>
                                    <button type="button" class="format-btn" data-cmd="removeFormat" title="Clear Format">üßπ</button>
                                    <button type="button" class="format-btn" id="colorBtn" title="Color">üé®</button>
                                    <input type="color" id="colorInput" style="visibility: hidden; width: 0; height: 0; position: absolute;">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <a href="dashboard.html" class="btn btn-outline-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary btn-lg px-4" id="submitBtn">
                                    Publish Post
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer mt-auto">
        <div class="container text-center py-4">
            <p>&copy; 2024 BlogHub. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="script.js"></script>
    <script>
        // Initialize
        // checkAuthAccess(); // Removed as it's handled by script.js checkAuth()
        
        const toggleBtn = document.getElementById('toggleTools');
        const toolsMenu = document.getElementById('toolsMenu');
        const editor = document.getElementById('editor');
        const formatToolbar = document.getElementById('formatToolbar');

        // Toggle Tools Menu
        toggleBtn.addEventListener('click', () => {
            toggleBtn.classList.toggle('active');
            toolsMenu.classList.toggle('active');
        });

        // Trigger Hidden File Inputs
        function triggerUpload(type) {
            const inputId = `${type}Upload`;
            const input = document.getElementById(inputId);
            if (input) input.click();
        }

        // Handle File Uploads
        ['image', 'video', 'audio'].forEach(type => {
            const input = document.getElementById(`${type}Upload`);
            input.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Show loading state in button
                const btn = document.querySelector(`.tool-btn[onclick="triggerUpload('${type}')"]`);
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥';
                
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}.${fileExt}`;
                    const filePath = `${fileName}`;

                    // Upload to Supabase using new client name
                    const { data, error } = await supabaseClient.storage
                        .from('media') // Ensure bucket exists
                        .upload(filePath, file);

                    if (error) throw error;

                    // Get Public URL
                    const { data: publicData } = supabaseClient.storage
                        .from('media')
                        .getPublicUrl(filePath);

                    const publicUrl = publicData.publicUrl;
                    insertMedia(type, publicUrl);

                    showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} uploaded successfully!`, 'success');
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Error uploading file: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    input.value = ''; // Reset input
                    // Close menu
                    toggleBtn.classList.remove('active');
                    toolsMenu.classList.remove('active');
                }
            });
        });

        function insertMedia(type, url) {
            let html = '';
            if (type === 'image') {
                html = `<img src="${url}" class="img-fluid rounded my-3" alt="Uploaded Image">`;
            } else if (type === 'video') {
                html = `<video src="${url}" controls class="w-100 rounded my-3"></video>`;
            } else if (type === 'audio') {
                html = `<audio src="${url}" controls class="w-100 my-3"></audio>`;
            }
            execCmd('insertHTML', html);
        }

        function insertContent(type) {
             if (type === 'link') {
                 const url = prompt('Please paste the URL of the link you want to add:');
                 if (url) {
                    const text = prompt('Enter the text to display for this link:', 'Click here');
                    if (text) {
                        const html = `<a href="${url}" target="_blank" class="text-primary text-decoration-underline">${text}</a>`;
                        execCmd('insertHTML', html);
                    }
                 }
             } else if (type === 'embed') {
                 const code = prompt('Please paste the embed code (e.g. from YouTube, Twitter, etc.):');
                 if (code) execCmd('insertHTML', `<div class="embed-responsive my-3 text-center">${code}</div><p><br></p>`);
             }
             toggleBtn.classList.remove('active');
             toolsMenu.classList.remove('active');
        }

        // --- Formatting Toolbar Handling ---
        
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            
            // Check if selection is within editor
            if (!editor.contains(selection.anchorNode)) {
                 formatToolbar.classList.remove('active');
                 return;
            }

            if (selection.toString().length > 0) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // Position toolbar
                // Calculate relative to viewport, handling scroll is tricky with absolute
                // Ideally append toolbar to body or use fixed positioning
                // For simplicity, let's use fixed positioning based on rect
                // But CSS has absolute... let's adjust CSS if needed or update style here
                
                // Better approach for relative parent:
                // We need offset relative to the toolbar's offset parent (the .mb-3 container)
                // Let's assume the toolbar is inside .mb-3 which is relative.
                
                // Actually, let's calculate relative to the viewport and verify CSS
                // CSS: .formatting-toolbar is absolute. Parent is .mb-3? No, implicit parent is .mb-3 if it has position relative? No.
                // Let's check HTML structure. Toolbar is in .mb-3 div (line 97).
                // .mb-3 is bootstrap class, usually not relative.
                // I might need to make the container relative.
                
                // Updating style here:
                const containerRect = editor.parentElement.getBoundingClientRect(); // .mb-3 container
                const top = rect.top - containerRect.top - 50; // 50px above selection
                const left = rect.left - containerRect.left + (rect.width / 2) - (formatToolbar.offsetWidth / 2);
                
                formatToolbar.style.top = `${top}px`;
                formatToolbar.style.left = `${left}px`;
                formatToolbar.classList.add('active');
            } else {
                formatToolbar.classList.remove('active');
            }
        });

        // Initialize parent container relative position for toolbar
        document.querySelector('.formatting-toolbar').parentElement.style.position = 'relative';

        // Toolbar Buttons
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('mousedown', (e) => {
                const cmd = btn.dataset.cmd;
                if (cmd) {
                     e.preventDefault(); // Prevent losing focus
                     if (cmd === 'h2' || cmd === 'h3' || cmd === 'blockquote') {
                         document.execCommand('formatBlock', false, cmd);
                     } else if (cmd === 'removeFormat') {
                        document.execCommand('removeFormat', false, null);
                        document.execCommand('unlink', false, null); // Also remove links
                     } else {
                         document.execCommand(cmd, false, null);
                     }
                }
            });
        });

        // Color Picker
        const colorBtn = document.getElementById('colorBtn');
        const colorInput = document.getElementById('colorInput');
        let savedSelection;

        colorBtn.addEventListener('mousedown', (e) => {
             e.preventDefault(); // Prevent losing focus immediately
             const selection = window.getSelection();
             if (selection.rangeCount > 0) {
                 savedSelection = selection.getRangeAt(0);
             }
             // Use minimal timeout to ensure UI is ready
             setTimeout(() => colorInput.click(), 10);
        });

        colorInput.addEventListener('input', (e) => {
            // Restore selection
            if (savedSelection) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedSelection);
            }
            document.execCommand('foreColor', false, e.target.value);
        });
        
        // Ensure editor sidebar doesn't block clicks
        document.querySelector('.editor-sidebar').style.pointerEvents = 'none';
        document.getElementById('toggleTools').style.pointerEvents = 'auto'; // Re-enable for button
        document.getElementById('toolsMenu').style.pointerEvents = 'auto'; // Re-enable for menu


        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
            editor.focus();
        }

        // Handle Enter key to break out of quotes and formatting
        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter for soft break
                e.preventDefault();
                // Insert new paragraph
                document.execCommand('insertParagraph', false, null);
                // Force it to be a plain paragraph, breaking out of blockquotes/headers
                document.execCommand('formatBlock', false, 'p');
                // Remove formatting from the new line
                document.execCommand('removeFormat', false, null);
                document.execCommand('unlink', false, null);
                // Also explicitly turn off bold/italic if they persist (sometimes needed)
                document.execCommand('bold', false, null);
                if (document.queryCommandState('bold')) document.execCommand('bold', false, null);
                if (document.queryCommandState('italic')) document.execCommand('italic', false, null);
            }
        });

        // Handle Form Submission
        document.getElementById('richPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            // Get title from contenteditable
            const titleElement = document.getElementById('postTitle');
            const title = titleElement.innerText.trim(); // Use innerText to get plain text or innerHTML if we want rich text title? 
            // User requested "apply the text styling for the post title as well", so we should save innerHTML.
            const titleContent = titleElement.innerHTML; 
            
            const content = editor.innerHTML;

            if (!title || !editor.textContent.trim() && !content.includes('<img')) {
                 showAlert('Please enter a title and some content', 'danger');
                 return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Publishing...';

            try {
                // Get User
                const { data: { user } } = await supabaseClient.auth.getUser();
                const mockUser = JSON.parse(localStorage.getItem('demoUser'));
                const userId = user ? user.id : (mockUser ? mockUser.id : null);

                if (!userId) throw new Error("You must be logged in.");

                const { error } = await supabaseClient
                    .from('posts')
                    .insert([{ title: titleContent, content, user_id: userId }]);

                if (error) throw error;

                showAlert('Post published successfully!', 'success');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
            } catch (err) {
                console.error('Error:', err);
                showAlert(err.message, 'danger');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Publish Post';
            }
        });
    </script>
</body>
</html>
